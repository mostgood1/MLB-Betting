<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historical Analysis - MLB-Betting</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #4fd1c7;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #4fd1c7, #5f9ea0);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 209, 199, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #6a5acd, #9370db);
        }

        .btn.home {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            margin-right: auto; /* Push to left if in flex container */
        }

        .btn.home:hover {
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .date-input {
            padding: 12px;
            border: 2px solid #4fd1c7;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
        }

        .date-input::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            border-left: 4px solid #4fd1c7;
        }

        .recap-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
        }

        .recap-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #4fd1c7;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4fd1c7;
            display: block;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .game-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .game-teams {
            font-size: 1.1rem;
            font-weight: bold;
        }

        .away-team, .home-team {
            color: #4fd1c7;
        }

        .versus {
            color: #fff;
            margin: 0 8px;
        }

        .final-score {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .game-time {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .prediction-section, .performance-section {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .prediction-section h4, .performance-section h4 {
            margin-bottom: 10px;
            color: #4fd1c7;
        }

        .prediction-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 0.9rem;
        }

        .prediction-label {
            opacity: 0.8;
        }

        .prediction-value {
            font-weight: bold;
        }

        .winner-pred.correct {
            color: #4ade80;
        }

        .winner-pred.incorrect {
            color: #f87171;
        }

        .performance-grade {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px 0;
        }

        .grade-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        .grade-aplus, .grade-a { background: linear-gradient(45deg, #4ade80, #22c55e); }
        .grade-aminus, .grade-bplus { background: linear-gradient(45deg, #a3e635, #84cc16); }
        .grade-b, .grade-bminus { background: linear-gradient(45deg, #facc15, #eab308); }
        .grade-cplus, .grade-c { background: linear-gradient(45deg, #fb923c, #f97316); }
        .grade-cminus, .grade-dplus { background: linear-gradient(45deg, #f87171, #ef4444); }
        .grade-d, .grade-dminus, .grade-f { background: linear-gradient(45deg, #dc2626, #b91c1c); }

        .grade-letter {
            font-size: 1.2rem;
        }

        .grade-percentage {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .performance-details {
            margin-top: 10px;
        }

        .performance-details p {
            margin: 5px 0;
            font-size: 0.9rem;
        }

        .error {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        /* System Performance Analytics Styles */
        .system-performance {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(79, 209, 199, 0.1), rgba(79, 209, 199, 0.05));
            border-radius: 12px;
            border: 1px solid rgba(79, 209, 199, 0.2);
        }

        .system-performance h3 {
            color: #4fd1c7;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.4rem;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .metric-group h4 {
            color: #4fd1c7;
            margin-bottom: 15px;
            font-size: 1.1rem;
            text-align: center;
        }

        .metric-stats {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }

        .metric-item {
            text-align: center;
            flex: 1;
        }

        .metric-item.large {
            flex: 2;
        }

        .metric-value {
            display: block;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 5px;
        }

        .metric-value.grade-display {
            font-size: 2rem;
            color: #4fd1c7;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
            color: #b0b0b0;
        }

        .grade-distribution {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .grade-distribution h4 {
            color: #4fd1c7;
            margin-bottom: 15px;
            text-align: center;
        }

        .grade-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 10px;
            text-align: center;
        }

        .grade-bar {
            background: rgba(79, 209, 199, 0.3);
            border-radius: 4px;
            padding: 8px 4px;
            position: relative;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .grade-bar.has-games {
            background: linear-gradient(to top, #4fd1c7, rgba(79, 209, 199, 0.7));
        }

        .grade-label {
            font-weight: bold;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .grade-count {
            font-size: 0.8rem;
            opacity: 0.9;
            color: #ffffff;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .games-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèÜ Historical Analysis</h1>
            <p>Performance tracking and prediction accuracy analysis</p>
        </div>

        <div class="controls">
            <a href="/" class="btn home">üè† Back to Today's Games</a>
            <input type="date" id="analysis-date" class="date-input" />
            <button class="btn" onclick="loadAnalysis()">üìä Analyze Date</button>
            <button class="btn secondary" onclick="loadToday()">üìÖ Today</button>
        </div>

        <div id="status" class="status" style="display: none;">
            <div id="status-message"></div>
        </div>

        <div id="recap-section" class="recap-section" style="display: none;">
            <h2 class="recap-title">Performance Recap</h2>
            <div class="stats-grid">
                <div class="stat-item">
                    <span id="total-games" class="stat-value">-</span>
                    <div class="stat-label">Total Games</div>
                </div>
                <div class="stat-item">
                    <span id="correct-predictions" class="stat-value">-</span>
                    <div class="stat-label">Correct Predictions</div>
                </div>
                <div class="stat-item">
                    <span id="accuracy-rate" class="stat-value">-</span>
                    <div class="stat-label">Accuracy Rate</div>
                </div>
                <div class="stat-item">
                    <span id="average-grade" class="stat-value">-</span>
                    <div class="stat-label">Average Grade</div>
                </div>
                <div class="stat-item">
                    <span id="best-predictions" class="stat-value">-</span>
                    <div class="stat-label">A+ Predictions</div>
                </div>
            </div>
            
            <!-- System Performance Analytics Section -->
            <div id="system-performance" class="system-performance" style="display: none;">
                <h3>üéØ System Performance Analytics</h3>
                <div class="performance-metrics">
                    <div class="metric-group">
                        <h4>Winner Predictions</h4>
                        <div class="metric-stats">
                            <div class="metric-item">
                                <span id="winner-accuracy" class="metric-value">-</span>
                                <div class="metric-label">Overall Accuracy</div>
                            </div>
                            <div class="metric-item">
                                <span id="high-confidence-accuracy" class="metric-value">-</span>
                                <div class="metric-label">High Confidence</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-group">
                        <h4>Score Predictions</h4>
                        <div class="metric-stats">
                            <div class="metric-item">
                                <span id="avg-score-diff" class="metric-value">-</span>
                                <div class="metric-label">Avg Score Diff</div>
                            </div>
                            <div class="metric-item">
                                <span id="total-runs-diff" class="metric-value">-</span>
                                <div class="metric-label">Total Runs Diff</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metric-group">
                        <h4>System Grade</h4>
                        <div class="metric-stats">
                            <div class="metric-item large">
                                <span id="system-grade" class="metric-value grade-display">-</span>
                                <div class="metric-label">Overall Rating</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="grade-distribution" class="grade-distribution">
                    <h4>Grade Distribution</h4>
                    <div id="grade-chart" class="grade-chart"></div>
                </div>
            </div>
        </div>

        <div id="games-container">
            <div class="status" id="initial-loading">
                <div>üöÄ Loading yesterday's analysis...</div>
                <div style="font-size: 0.8em; margin-top: 5px;" id="debug-info">Debug: Initializing...</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            updateDebugInfo('Page loaded, calling loadToday()...');
            setTimeout(function() {
                loadToday();
            }, 100);
        });

        function updateDebugInfo(message) {
            const debugElement = document.getElementById('debug-info');
            if (debugElement) {
                debugElement.textContent = 'Debug: ' + message;
            }
            console.log('DEBUG:', message);
        }

        function loadToday() {
            console.log('Loading previous day for historical analysis...');
            updateDebugInfo('loadToday() called - defaulting to previous day');
            
            // Get yesterday's date instead of today
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            
            const year = yesterday.getFullYear();
            const month = yesterday.getMonth() + 1;
            const day = yesterday.getDate();
            
            const monthStr = month < 10 ? '0' + month : month.toString();
            const dayStr = day < 10 ? '0' + day : day.toString();
            const yesterdayString = year + '-' + monthStr + '-' + dayStr;
            
            console.log('Previous day calculated as:', yesterdayString);
            updateDebugInfo('Previous day: ' + yesterdayString + ', calling loadAnalysis()...');
            
            document.getElementById('analysis-date').value = yesterdayString;
            loadAnalysis();
        }

        function loadAnalysis() {
            const date = document.getElementById('analysis-date').value;
            if (!date) {
                alert('Please select a date');
                updateDebugInfo('ERROR: No date selected');
                return;
            }

            console.log('Loading analysis for:', date);
            updateDebugInfo('Starting API call for date: ' + date);
            showStatus('üîÑ Loading analysis for ' + date + '...');
            
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/historical-recap/' + date, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    updateDebugInfo('API response received, status: ' + xhr.status);
                    if (xhr.status === 200) {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            console.log('Data received:', data);
                            updateDebugInfo('Data parsed successfully, success: ' + data.success + ', games: ' + (data.games ? data.games.length : 'null'));
                            
                            if (data.success && data.games && data.games.length > 0) {
                                updateDebugInfo('Calling displayRecap and displayGames...');
                                displayRecap(data, date);
                                displayGames(data.games);
                                hideStatus();
                                updateDebugInfo('Display complete - ' + data.games.length + ' games shown');
                            } else {
                                updateDebugInfo('ERROR: No games condition failed');
                                showStatus('‚ùå No games found for ' + date);
                            }
                        } catch (error) {
                            console.error('Parse error:', error);
                            updateDebugInfo('ERROR: Parse error - ' + error.message);
                            showStatus('‚ùå Error loading data: ' + error.message);
                        }
                    } else {
                        console.error('HTTP error:', xhr.status);
                        updateDebugInfo('ERROR: HTTP error ' + xhr.status);
                        showStatus('‚ùå Failed to load data (HTTP ' + xhr.status + ')');
                    }
                }
            };
            xhr.send();
        }

        function showStatus(message) {
            const status = document.getElementById('status');
            const statusMessage = document.getElementById('status-message');
            statusMessage.textContent = message;
            status.style.display = 'block';
        }

        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }

        function displayRecap(data, date) {
            try {
                console.log('Displaying recap for', data.games.length, 'games');
                
                const recapSection = document.getElementById('recap-section');
                recapSection.style.display = 'block';

                // Update date in title
                const dateObj = new Date(date + 'T00:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                document.querySelector('.recap-title').textContent = 'Performance Recap - ' + formattedDate;

                // Calculate stats
                const games = data.games;
                const gamesWithAnalysis = games.filter(function(game) {
                    return game.performance_analysis;
                });
                
                const correctWinners = gamesWithAnalysis.filter(function(game) {
                    return game.performance_analysis.winner_correct;
                }).length;
                
                const gradePoints = gamesWithAnalysis.map(function(game) {
                    const percentage = game.performance_analysis.grade_percentage;
                    return (percentage !== null && percentage !== undefined && !isNaN(percentage)) ? Number(percentage) : 0;
                });
                
                const avgGrade = gradePoints.length > 0 ? 
                    gradePoints.reduce(function(a, b) { return a + b; }, 0) / gradePoints.length : 0;

                const aPlusCount = gamesWithAnalysis.filter(function(game) {
                    return game.performance_analysis.grade === 'A+';
                }).length;

                // Update display
                document.getElementById('total-games').textContent = games.length;
                document.getElementById('correct-predictions').textContent = correctWinners + '/' + gamesWithAnalysis.length;
                document.getElementById('accuracy-rate').textContent = gamesWithAnalysis.length > 0 ? 
                    Math.round((correctWinners / gamesWithAnalysis.length) * 100) + '%' : 'N/A';
                document.getElementById('average-grade').textContent = avgGrade > 0 ? avgGrade.toFixed(1) + '%' : 'N/A';
                document.getElementById('best-predictions').textContent = aPlusCount;
                
                // Load performance analytics
                loadPerformanceAnalytics(date);

            } catch (error) {
                console.error('Error in displayRecap:', error);
            }
        }

        function displayGames(games) {
            console.log('Displaying', games.length, 'games');
            updateDebugInfo('displayGames called with ' + games.length + ' games');
            
            const container = document.getElementById('games-container');
            container.innerHTML = '';

            const gamesGrid = document.createElement('div');
            gamesGrid.className = 'games-grid';

            for (var i = 0; i < games.length; i++) {
                try {
                    const gameCard = createGameCard(games[i]);
                    gamesGrid.appendChild(gameCard);
                } catch (error) {
                    console.error('Error creating game card:', error);
                    updateDebugInfo('ERROR creating game card ' + i + ': ' + error.message);
                    const errorCard = document.createElement('div');
                    errorCard.className = 'game-card error';
                    errorCard.innerHTML = '<p>Error displaying game: ' + (games[i].away_team || 'Unknown') + ' @ ' + (games[i].home_team || 'Unknown') + '</p>';
                    gamesGrid.appendChild(errorCard);
                }
            }

            container.appendChild(gamesGrid);
            updateDebugInfo('Games display completed successfully');
        }

        function createGameCard(game) {
            const card = document.createElement('div');
            card.className = 'game-card';

            const prediction = game.prediction || {};
            const result = game.result || {};
            const analysis = game.performance_analysis || {};
            
            const isComplete = result.away_score !== null && result.home_score !== null && 
                             result.away_score !== undefined && result.home_score !== undefined;
            const actualWinner = isComplete ? 
                (result.away_score > result.home_score ? game.away_team : game.home_team) : '';
            
            // Calculate predicted winner from probabilities
            let predictedWinner = 'N/A';
            if (prediction.away_win_probability && prediction.home_win_probability) {
                if (prediction.away_win_probability > prediction.home_win_probability) {
                    predictedWinner = game.away_team;
                } else if (prediction.home_win_probability > prediction.away_win_probability) {
                    predictedWinner = game.home_team;
                } else {
                    predictedWinner = 'Tie/Close';
                }
            } else if (prediction.predicted_winner) {
                predictedWinner = prediction.predicted_winner;
            }
            
            const grade = analysis.overall_grade || 'N/A';
            const gradePercentage = analysis.grade_percentage;
            
            // Safe helper functions
            function safeToFixed(value, decimals) {
                if (value === null || value === undefined || isNaN(value)) {
                    return 'N/A';
                }
                return Number(value).toFixed(decimals);
            }
            
            function safePercentage(value) {
                if (value === null || value === undefined || isNaN(value)) {
                    return 'N/A';
                }
                return Number(value * 100).toFixed(1) + '%';
            }
        
            card.innerHTML = 
                '<div class="game-header">' +
                    '<div class="game-teams">' +
                        '<span class="away-team">' + game.away_team + '</span>' +
                        '<span class="versus">@</span>' +
                        '<span class="home-team">' + game.home_team + '</span>' +
                    '</div>' +
                    '<div class="game-score">' +
                        (isComplete ? 
                            '<span class="final-score">' + result.away_score + ' - ' + result.home_score + '</span>' :
                            '<span class="game-time">' + (game.game_time || 'TBD') + '</span>') +
                    '</div>' +
                '</div>' +
                
                '<div class="prediction-section">' +
                    '<h4>üéØ Our Prediction</h4>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Winner:</span>' +
                        '<span class="prediction-value winner-pred ' + 
                            (predictedWinner === actualWinner && isComplete ? 'correct' : 
                             isComplete ? 'incorrect' : '') + '">' + 
                            predictedWinner + 
                            (isComplete ? (predictedWinner === actualWinner ? ' ‚úÖ' : ' ‚ùå') : '') +
                        '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Away Win Prob:</span>' +
                        '<span class="prediction-value">' + safePercentage(prediction.away_win_probability) + '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Home Win Prob:</span>' +
                        '<span class="prediction-value">' + safePercentage(prediction.home_win_probability) + '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Predicted Score:</span>' +
                        '<span class="prediction-value">' + 
                            (prediction.predicted_away_score !== undefined && prediction.predicted_home_score !== undefined ? 
                                safeToFixed(prediction.predicted_away_score, 1) + ' - ' + safeToFixed(prediction.predicted_home_score, 1) : 'N/A') +
                        '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Total Runs:</span>' +
                        '<span class="prediction-value">' + safeToFixed(prediction.predicted_total_runs, 1) + '</span>' +
                    '</div>' +
                    '<div class="prediction-row">' +
                        '<span class="prediction-label">Pitchers:</span>' +
                        '<span class="prediction-value">' + (prediction.away_pitcher || 'TBD') + ' vs ' + (prediction.home_pitcher || 'TBD') + '</span>' +
                    '</div>' +
                '</div>' +
                
                (isComplete ?
                '<div class="performance-section">' +
                    '<h4>üìä Performance Analysis</h4>' +
                    '<div class="performance-grade grade-' + (grade.toLowerCase().replace('+', 'plus').replace('-', 'minus')) + '">' +
                        '<div class="grade-display">' +
                            '<span class="grade-letter">' + grade + '</span>' +
                            '<span class="grade-percentage">' + safePercentage(gradePercentage) + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="performance-details">' +
                        '<p><strong>Winner Prediction:</strong> ' + (analysis.winner_correct ? '‚úÖ Correct' : '‚ùå Incorrect') + '</p>' +
                        (analysis.score_accuracy ? 
                            '<p><strong>Score Accuracy:</strong> ¬±' + safeToFixed(analysis.score_accuracy.total_diff, 1) + ' runs</p>' : '') +
                    '</div>' +
                '</div>' :
                '<div class="status"><p>üîÑ Game in progress</p></div>') +
            
            '<div style="margin-top: 10px; font-size: 0.8rem; color: #94a3b8;">' +
                'Game ID: ' + game.game_id +
            '</div>';

            return card;
        }

        // Performance Analytics Functions
        function loadPerformanceAnalytics(date) {
            console.log('Loading performance analytics for', date);
            updateDebugInfo('Loading performance analytics for ' + date);
            
            fetch('/api/performance-analytics/' + date)
                .then(response => response.json())
                .then(data => {
                    console.log('Performance analytics response:', data);
                    if (data.success) {
                        displayPerformanceAnalytics(data.analytics);
                    } else {
                        console.error('Performance analytics failed:', data.error);
                        updateDebugInfo('Performance analytics failed: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading performance analytics:', error);
                    updateDebugInfo('Error loading performance analytics: ' + error.message);
                });
        }

        function displayPerformanceAnalytics(analytics) {
            console.log('Displaying performance analytics:', analytics);
            
            // Show the system performance section
            document.getElementById('system-performance').style.display = 'block';
            
            // Update winner prediction metrics
            const winnerPerf = analytics.winner_performance || {};
            document.getElementById('winner-accuracy').textContent = (winnerPerf.accuracy_rate || 0) + '%';
            
            const highConfidence = winnerPerf.by_confidence?.high || {};
            document.getElementById('high-confidence-accuracy').textContent = (highConfidence.accuracy || 0) + '%';
            
            // Update score prediction metrics
            const scorePerf = analytics.score_performance || {};
            const avgScoreDiff = ((scorePerf.avg_away_diff || 0) + (scorePerf.avg_home_diff || 0)) / 2;
            document.getElementById('avg-score-diff').textContent = avgScoreDiff.toFixed(1);
            document.getElementById('total-runs-diff').textContent = (scorePerf.avg_total_diff || 0).toFixed(1);
            
            // Update system grade
            const systemGrade = analytics.overall_system_letter || 'N/A';
            const systemPercentage = analytics.overall_system_grade || 0;
            document.getElementById('system-grade').textContent = systemGrade + ' (' + systemPercentage.toFixed(1) + '%)';
            
            // Update grade distribution
            displayGradeDistribution(analytics.grade_distribution || {});
            
            updateDebugInfo('Performance analytics displayed successfully');
        }

        function displayGradeDistribution(gradeDistribution) {
            const gradeChart = document.getElementById('grade-chart');
            gradeChart.innerHTML = '';
            
            const grades = ['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D+', 'D'];
            
            grades.forEach(grade => {
                const count = gradeDistribution[grade] || 0;
                const gradeBar = document.createElement('div');
                gradeBar.className = 'grade-bar' + (count > 0 ? ' has-games' : '');
                
                gradeBar.innerHTML = 
                    '<div class="grade-label">' + grade + '</div>' +
                    '<div class="grade-count">' + count + '</div>';
                
                gradeChart.appendChild(gradeBar);
            });
        }

        // Modify the loadHistoricalRecap function to also load performance analytics
        function loadHistoricalRecap(date) {
            if (!date) {
                updateDebugInfo('No date provided to loadHistoricalRecap');
                return;
            }

            updateDebugInfo('Loading historical recap for ' + date);
            document.getElementById('recap-section').style.display = 'block';
            
            fetch('/api/historical-recap/' + date)
                .then(response => {
                    updateDebugInfo('Received response, status: ' + response.status);
                    return response.json();
                })
                .then(data => {
                    updateDebugInfo('Data parsed successfully, success: ' + data.success + ', games: ' + (data.games ? data.games.length : 'null'));
                    
                    if (data.success && data.games && data.games.length > 0) {
                        const formattedDate = formatDate(date);
                        document.querySelector('.recap-title').textContent = 'Performance Recap - ' + formattedDate;
                        displayGames(data.games);
                        updateStats(data.games);
                        updateDebugInfo('Display complete - ' + data.games.length + ' games shown');
                        
                        // Load performance analytics
                        loadPerformanceAnalytics(date);
                    } else {
                        updateDebugInfo('No games found for ' + date);
                        document.getElementById('games-container').innerHTML = '<div class="status error">No games found for ' + date + '</div>';
                    }
                })
                .catch(error => {
                    updateDebugInfo('Error: ' + error.message);
                    console.error('Error loading historical recap:', error);
                    document.getElementById('games-container').innerHTML = '<div class="status error">Error loading data: ' + error.message + '</div>';
                });
        }
    </script>
</body>
</html>
